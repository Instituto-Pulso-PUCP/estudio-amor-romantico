---
title: "AFE con toda la muestra"
author: "Guillermo Soto"
date: "2025-07-15"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r}
library(haven)
library(tidyverse)
library(psych)
library(sjlabelled)
library(expss)
library(DT)
library(htmltools)
library(FactoMineR)
library(factoextra)
library(EGAnet)
library(polycor)
library(openxlsx)
```

```{r}
data<-haven::read_sav("Amor_romantico_data_PUCP_3.sav")
```


# AFE con toda la muestra

```{r}
subdata<-data|>
  filter(q0001 == 1)|> #¿Estás de acuerdo en responder la encuesta?
  filter(q0002 !=3)|> #¿Actualmente, eres estudiante universitario/a de la PUCP, de la UNMSM u otra?
  filter(q0003 == 1)|> #¿Tienes entre 18 y 25 años?
  filter(q0004 == 1) #¿Eres de nacionalidad peruana y/o resides en el Perú?
```

## Mitos

```{r}
AFE_data<-subdata|>
  select(q0013_0001:q0013_0010,
         q0014_0001:q0014_0010)|>
  filter(if_all(c(q0013_0001:q0013_0010, q0014_0001:q0014_0010), ~ . != 0))
cat("Números de casos =", nrow(AFE_data))
```

### Frecuencias

```{r}
as.datatable_widget(AFE_data|>tab_cells("|" = unvr(q0013_0001))|>
                      tab_stat_cpct(label=var_lab(q0013_0001),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0013_0002))|>
                      tab_stat_cpct(label=var_lab(q0013_0002),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0013_0003))|>
                      tab_stat_cpct(label=var_lab(q0013_0003),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0013_0004))|>

                      tab_stat_cpct(label=var_lab(q0013_0004),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0013_0005))|>
                      tab_stat_cpct(label=var_lab(q0013_0005),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0013_0006))|>
                      tab_stat_cpct(label=var_lab(q0013_0006),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0013_0007))|>
                      tab_stat_cpct(label=var_lab(q0013_0007),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0013_0008))|>
                      tab_stat_cpct(label=var_lab(q0013_0008),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0013_0009))|>
                      tab_stat_cpct(label=var_lab(q0013_0009),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0013_0010))|>
                      tab_stat_cpct(label=var_lab(q0013_0010),total_row_position = "below")|>
                      tab_pivot(stat_position="inside_columns")|>
                      t())
```

```{r}

as.datatable_widget(AFE_data|>tab_cells("|" = unvr(q0014_0001))|>
                      tab_stat_cpct(label=var_lab(q0014_0001),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0014_0002))|>
                      tab_stat_cpct(label=var_lab(q0014_0002),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0014_0003))|>
                      tab_stat_cpct(label=var_lab(q0014_0003),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0014_0004))|>

                      tab_stat_cpct(label=var_lab(q0014_0004),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0014_0005))|>
                      tab_stat_cpct(label=var_lab(q0014_0005),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0014_0006))|>
                      tab_stat_cpct(label=var_lab(q0014_0006),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0014_0007))|>
                      tab_stat_cpct(label=var_lab(q0014_0007),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0014_0008))|>
                      tab_stat_cpct(label=var_lab(q0014_0008),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0014_0009))|>
                      tab_stat_cpct(label=var_lab(q0014_0009),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0014_0010))|>
                      tab_stat_cpct(label=var_lab(q0014_0010),total_row_position = "below")|>
                      tab_pivot(stat_position="inside_columns")|>
                      t())
```


### Pruebas

A excepción de la matriz, todos los resultados de los indicadores resultan buenos.

```{r}
matrix_cor<-polychoric(AFE_data)
rho<-matrix_cor$rho
cor.plot(rho, xlas = 2, cex.axis = 0.8)
```

```{r}
#KMO
KMO(rho)
```

```{r}
n<-nrow(AFE_data)
cortest.bartlett(rho, n)
```

### Número de factores

Realizamos 4 pruebas. Todas indican entre 2 a 4 factores, pero la mayor tendencia apunta de 3 y 4

#### autovalores

```{r}
ei<-eigen(rho)$values
plot(ei,type="b",pch=20,col="blue")
num_factores_kaiser <- sum(ei > 1)  # Contar cuántos autovalores son mayores a 1
print(num_factores_kaiser)  # Mostrar número de factores sugeridos
```

#### Scree plot

```{r}
plot(ei, type="b", main="Scree Plot (Codo de Cattell)", xlab="Número de Factor", ylab="Autovalor")
abline(h=1, col="red", lty=2)  # Línea de referencia en autovalor = 1
```



#### Parallel analysis

```{r}
fa.parallel(rho, main = "Parallel", fa ="fa", fm="minres")
```

#### Eganet

```{r}
EGAnet::EGA(AFE_data, corr = "auto", plot.EGA = TRUE)
```

### 2 factores

En el caso de dos factores la varianza explicada no es tan alta pero si adecuada aun.

```{r}
factorial <- fa(rho,nfactors = 2, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:2]
```

```{r,  fig.width=15, fig.height=7}
fa.diagram(load)
```

### 3 factores

Colocando tres factores tampoco mejor mucho la varianza

```{r}
factorial <- fa(rho,nfactors = 3, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:3]
```

```{r,fig.width=12, fig.height=7}
fa.diagram(load)
```

### 4 factores

```{r}
factorial <- fa(rho,nfactors = 4, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

Aquí hay una mejora aceptable de la varianza.

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:4]
```

```{r, ,fig.width=12, fig.height=7}
fa.diagram(load)
```




## mitos q0013

Aquí la matriz mejora aunque no tanto y los indicadores siguen adecuados

```{r}
AFE_data<-subdata|>
  select(q0013_0001:q0013_0010)|>
  filter(if_all(c(q0013_0001:q0013_0010), ~ . != 0))
cat("Números de casos =", nrow(AFE_data))
```

#### Pruebas

```{r}
matrix_cor<-polychoric(AFE_data)
rho<-matrix_cor$rho
cor.plot(rho, xlas = 2, cex.axis = 0.8)
```

```{r}
#KMO
KMO(rho)
```

```{r}
n<-nrow(AFE_data)
cortest.bartlett(rho, n)
```

#### Número de factores

Realizamos 4 pruebas. Aquí si es más claro que son 2 factores 

##### autovalores

```{r}
ei<-eigen(rho)$values
plot(ei,type="b",pch=20,col="blue")
num_factores_kaiser <- sum(ei > 1)  # Contar cuántos autovalores son mayores a 1
print(num_factores_kaiser)  # Mostrar número de factores sugeridos
```

##### Scree plot

```{r}
plot(ei, type="b", main="Scree Plot (Codo de Cattell)", xlab="Número de Factor", ylab="Autovalor")
abline(h=1, col="red", lty=2)  # Línea de referencia en autovalor = 1
```



##### Parallel analysis

```{r}
fa.parallel(rho, main = "Parallel", fa ="fa", fm="minres")
```

##### Eganet

```{r}
EGAnet::EGA(AFE_data, corr = "auto", plot.EGA = TRUE)
```

#### 2 factores

Sin embargo la varianza no es tan buena como se esperaría. Igual valor cercano a 0.3 es aceptable.

```{r}
factorial <- fa(rho,nfactors = 2, rotate = "varimax", fm = "minres")
print(factorial)
```

##### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:2]
```

```{r, fig.width= 11}
fa.diagram(load)
```

#### 3 factores

No hay un gran cambio de la varianza acumulada y parece que los pesos se mantienen estables. No hay ninguno muy bajo ni muy alto. Conviene explorar ambos en el AFC o confirmar teóricamente.

```{r}
factorial <- fa(rho,nfactors = 3, rotate = "varimax", fm = "minres")
print(factorial)
```

##### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:3]
```

```{r, fig.width=11}
fa.diagram(load)
```

## mitos q0014

```{r}
AFE_data<-subdata|>
  select(q0014_0001:q0014_0010)|>
  filter(if_all(c(q0014_0001:q0014_0010), ~ . != 0))
cat("Números de casos =", nrow(AFE_data))
```

### Pruebas

La matriz y los indicadores se ven buenos.

```{r}
matrix_cor<-polychoric(AFE_data)
rho<-matrix_cor$rho
cor.plot(rho, xlas = 2, cex.axis = 0.8)
```

```{r}
#KMO
KMO(rho)
```

```{r}
n<-nrow(AFE_data)
cortest.bartlett(rho, n)
```

### Número de factores

Realizamos 4 pruebas. En todas se sugiere que son 2 factores.

#### autovalores

```{r}
ei<-eigen(rho)$values
plot(ei,type="b",pch=20,col="blue")
num_factores_kaiser <- sum(ei > 1)  # Contar cuántos autovalores son mayores a 1
print(num_factores_kaiser)  # Mostrar número de factores sugeridos
```

#### Scree plot

```{r}
plot(ei, type="b", main="Scree Plot (Codo de Cattell)", xlab="Número de Factor", ylab="Autovalor")
abline(h=1, col="red", lty=2)  # Línea de referencia en autovalor = 1
```



#### Parallel analysis

```{r}
fa.parallel(rho, main = "Parallel", fa ="fa", fm="minres")
```

#### Eganet

```{r}
EGAnet::EGA(AFE_data, corr = "auto", plot.EGA = TRUE)
```

### 2 factores

Aquí la varianza funciona mucho mejor que en la anterior. Por ahora 2 factores está bien.

```{r}
factorial <- fa(rho,nfactors = 2, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:2]
```

```{r, fig.width=11}
fa.diagram(load)
```

### 3 factores

No hay mayor problema con 3 factores. Por ahora ambos funciona bien pero es necesario comprobar cual queda.

```{r}
factorial <- fa(rho,nfactors = 3, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:3]
```

```{r,  fig.width=11}
fa.diagram(load)
```

## Estereotipos de género

```{r}
AFE_data<-subdata|>
  select(q0015_0001:q0015_0005)|>
  filter(if_all(c(q0015_0001:q0015_0005), ~ . != 0))
cat("Números de casos =", nrow(AFE_data))
```

### Frecuencias

```{r}
as.datatable_widget(AFE_data|>tab_cells("|" = unvr(q0015_0001))|>
                      tab_stat_cpct(label=var_lab(q0015_0001),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0015_0002))|>
                      tab_stat_cpct(label=var_lab(q0015_0002),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0015_0003))|>
                      tab_stat_cpct(label=var_lab(q0015_0003),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0015_0004))|>
                      tab_stat_cpct(label=var_lab(q0015_0004),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0015_0005))|>
                      tab_stat_cpct(label=var_lab(q0015_0005),total_row_position = "below")|>
                      tab_pivot(stat_position="inside_columns")|>
                      t()|>
  set_caption("Tolerancia hacia la violencia offline"))
```



### Pruebas

Matriz e indicadores son aceptables

```{r}
matrix_cor<-polychoric(AFE_data)
rho<-matrix_cor$rho
cor.plot(rho, xlas = 2, cex.axis = 0.8)
```

```{r}
#KMO
KMO(rho)
```

```{r}
n<-nrow(AFE_data)
cortest.bartlett(rho, n)
```

### Número de factores

Realizamos 4 pruebas

#### autovalores

```{r}
ei<-eigen(rho)$values
plot(ei,type="b",pch=20,col="blue")
num_factores_kaiser <- sum(ei > 1)  # Contar cuántos autovalores son mayores a 1
print(num_factores_kaiser)  # Mostrar número de factores sugeridos
```

#### Scree plot

```{r}
plot(ei, type="b", main="Scree Plot (Codo de Cattell)", xlab="Número de Factor", ylab="Autovalor")
abline(h=1, col="red", lty=2)  # Línea de referencia en autovalor = 1
```



#### Parallel analysis

```{r}
fa.parallel(rho, main = "Parallel", fa ="fa", fm="minres")
```

#### Eganet

```{r}
EGAnet::EGA(AFE_data, corr = "auto", plot.EGA = TRUE)
```

### 1 factor

Luego de ver todo, el mejor dato es 1. Se puede hacer una escala unidimensional. Se probó con 2 factores nuevamente y no hay mejor con esta nueva base de datos.

```{r}
factorial <- fa(rho,nfactors = 1, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings
```

```{r,  fig.width=11}
fa.diagram(load)
```

### 2 factores

```{r}
factorial <- fa(rho,nfactors = 2, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:2]
```

```{r,fig.width=12, fig.height=7}
fa.diagram(load)
```

## Tolerancia

```{r}

AFE_data<-subdata|>
  select(q0016_0001:q0016_0010,
         q0017_0001:q0017_0010)|>
  filter(if_all(c(q0016_0001:q0016_0010,
                  q0017_0001:q0017_0010), ~ . != 0))
cat("Números de casos =", nrow(AFE_data))
```

### Frecuencias

```{r}
as.datatable_widget(AFE_data|>tab_cells("|" = unvr(q0016_0001))|>
                      tab_stat_cpct(label=var_lab(q0016_0001),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0002))|>
                      tab_stat_cpct(label=var_lab(q0016_0002),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0003))|>
                      tab_stat_cpct(label=var_lab(q0016_0003),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0004))|>
                      tab_stat_cpct(label=var_lab(q0016_0004),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0005))|>
                      tab_stat_cpct(label=var_lab(q0016_0005),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0006))|>
                      tab_stat_cpct(label=var_lab(q0016_0006),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0007))|>
                      tab_stat_cpct(label=var_lab(q0016_0007),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0008))|>
                      tab_stat_cpct(label=var_lab(q0016_0008),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0009))|>
                      tab_stat_cpct(label=var_lab(q0016_0009),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0010))|>
                      tab_stat_cpct(label=var_lab(q0016_0010),total_row_position = "below")|>
                      tab_pivot(stat_position="inside_columns")|>
                      t())
```

```{r}
as.datatable_widget(AFE_data|>tab_cells("|" = unvr(q0017_0001))|>
                      tab_stat_cpct(label=var_lab(q0017_0001),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0002))|>
                      tab_stat_cpct(label=var_lab(q0017_0002),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0003))|>
                      tab_stat_cpct(label=var_lab(q0017_0003),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0004))|>
                      tab_stat_cpct(label=var_lab(q0017_0004),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0005))|>
                      tab_stat_cpct(label=var_lab(q0017_0005),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0006))|>
                      tab_stat_cpct(label=var_lab(q0017_0006),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0007))|>
                      tab_stat_cpct(label=var_lab(q0017_0007),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0008))|>
                      tab_stat_cpct(label=var_lab(q0017_0008),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0009))|>
                      tab_stat_cpct(label=var_lab(q0017_0009),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0010))|>
                      tab_stat_cpct(label=var_lab(q0017_0010),total_row_position = "below")|>
                      tab_pivot(stat_position="inside_columns")|>
                      t())
```

### Pruebas

Aquí tenemos una excelente matriz e indicador. Solo un indicador es aceptable.

```{r}
matrix_cor<-polychoric(AFE_data)
rho<-matrix_cor$rho
cor.plot(rho, xlas = 2, cex.axis = 0.8)
```

```{r}
#KMO
KMO(rho)
```

```{r}
n<-nrow(AFE_data)
cortest.bartlett(rho, n)
```

### Número de factores

Realizamos 4 pruebas. De todas varias nos apunta a dos resultados: 3 o 4 factores.

#### autovalores

```{r}
ei<-eigen(rho)$values
plot(ei,type="b",pch=20,col="blue")
num_factores_kaiser <- sum(ei > 1)  # Contar cuántos autovalores son mayores a 1
print(num_factores_kaiser)  # Mostrar número de factores sugeridos
```

#### Scree plot

```{r}
plot(ei, type="b", main="Scree Plot (Codo de Cattell)", xlab="Número de Factor", ylab="Autovalor")
abline(h=1, col="red", lty=2)  # Línea de referencia en autovalor = 1
```



#### Parallel analysis

```{r}
fa.parallel(rho, main = "Parallel", fa ="fa", fm="minres")
```

#### Eganet

```{r}
EGAnet::EGA(AFE_data, corr = "auto", plot.EGA = TRUE)
```


### 3 factores

Con 3 factores la varianza es buena aunque un peso es algo alto de 0.9

```{r}
factorial <- fa(rho,nfactors = 3, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:3]
```

```{r,fig.width=13, fig.height=7}
fa.diagram(load)
```

### 4 factores

4 factores siguen siendo bueno. Conviene revisar el EGANET para ver que por mas que diga 4 tres son los más distinguibles.

```{r}
factorial <- fa(rho,nfactors = 4, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:4]
```

```{r, ,fig.width=14, fig.height=7}
fa.diagram(load)
```

## tolerancia offline

```{r}
AFE_data<-subdata|>
  select(q0016_0001:q0016_0010)|>
  filter(if_all(c(q0016_0001:q0016_0010), ~ . != 0))
cat("Números de casos =", nrow(AFE_data))
```

#### Pruebas

A diferencia del conjunto aqui todos los indicadores son buenos.

```{r}
matrix_cor<-polychoric(AFE_data)
rho<-matrix_cor$rho
cor.plot(rho, xlas = 2, cex.axis = 0.8)
```

```{r}
#KMO
KMO(rho)
```

```{r}
n<-nrow(AFE_data)
cortest.bartlett(rho, n)
```

#### Número de factores

Realizamos 4 pruebas. Todas apunta a 2 factores. Incluso donde se sugiere 3, tiende más a 2

##### autovalores

```{r}
ei<-eigen(rho)$values
plot(ei,type="b",pch=20,col="blue")
num_factores_kaiser <- sum(ei > 1)  # Contar cuántos autovalores son mayores a 1
print(num_factores_kaiser)  # Mostrar número de factores sugeridos
```

##### Scree plot

```{r}
plot(ei, type="b", main="Scree Plot (Codo de Cattell)", xlab="Número de Factor", ylab="Autovalor")
abline(h=1, col="red", lty=2)  # Línea de referencia en autovalor = 1
```



##### Parallel analysis

```{r}
fa.parallel(rho, main = "Parallel", fa ="fa", fm="minres")
```

##### Eganet

```{r}
EGAnet::EGA(AFE_data, corr = "auto", plot.EGA = TRUE)
```

#### 2 factores

2 factores tiene buena varianza y pesos adecuados

```{r}
factorial <- fa(rho,nfactors = 2, rotate = "varimax", fm = "minres")
print(factorial)
```

##### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:2]
```

```{r, fig.width= 11}
fa.diagram(load)
```

#### 3 factores

No hay grandes cambios con tres factores. Solo queda ver cual se asemeja más a la teoría

```{r}
factorial <- fa(rho,nfactors = 3, rotate = "varimax", fm = "minres")
print(factorial)
```

##### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:3]
```

```{r, fig.width=11}
fa.diagram(load)
```

## Tolerancia online

```{r}
AFE_data<-subdata|>
  select(q0017_0001:q0017_0010)|>
  filter(if_all(c(q0017_0001:q0017_0010), ~ . != 0))
cat("Números de casos =", nrow(AFE_data))
```

### Pruebas

Buenos indicadores. Tal parece que tolerancia funciona mucho mejor por separados que en conjunto

```{r}
matrix_cor<-polychoric(AFE_data)
rho<-matrix_cor$rho
cor.plot(rho, xlas = 2, cex.axis = 0.8)
```

```{r}
#KMO
KMO(rho)
```

```{r}
n<-nrow(AFE_data)
cortest.bartlett(rho, n)
```

### Número de factores

Realizamos 4 pruebas. No es tan clara la división entre 2 y 3 factores

#### autovalores

```{r}
ei<-eigen(rho)$values
plot(ei,type="b",pch=20,col="blue")
num_factores_kaiser <- sum(ei > 1)  # Contar cuántos autovalores son mayores a 1
print(num_factores_kaiser)  # Mostrar número de factores sugeridos
```

#### Scree plot

```{r}
plot(ei, type="b", main="Scree Plot (Codo de Cattell)", xlab="Número de Factor", ylab="Autovalor")
abline(h=1, col="red", lty=2)  # Línea de referencia en autovalor = 1
```



#### Parallel analysis

```{r}
fa.parallel(rho, main = "Parallel", fa ="fa", fm="minres")
```

#### Eganet

```{r}
EGAnet::EGA(AFE_data, corr = "auto", plot.EGA = TRUE)
```

### 2 factores

Tiene buena varianza pero algo de sobrerepresentación. Quizás podemos probar en el AFC a ver qué pasa.

```{r}
factorial <- fa(rho,nfactors = 2, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores


```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:2]
```

```{r, fig.width=11}
fa.diagram(load)
```

### 3 factores

Algo similar pasa con 3 factores que con dos. Hay sobrerepresentación. Veamos cual se corrige en el AFC

```{r}
factorial <- fa(rho,nfactors = 3, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:3]
```

```{r,  fig.width=11}
fa.diagram(load)
```


## Tolerancia sin q0017_0009 (el pack)

```{r}

AFE_data<-subdata|>
  select(q0016_0001:q0016_0010,
         q0017_0001:q0017_0008, q0017_0010)|>
  filter(if_all(c(q0016_0001:q0016_0010,
                  q0017_0001:q0017_0010), ~ . != 0))
cat("Números de casos =", nrow(AFE_data))
```

### Frecuencias

```{r}
as.datatable_widget(AFE_data|>tab_cells("|" = unvr(q0016_0001))|>
                      tab_stat_cpct(label=var_lab(q0016_0001),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0002))|>
                      tab_stat_cpct(label=var_lab(q0016_0002),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0003))|>
                      tab_stat_cpct(label=var_lab(q0016_0003),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0004))|>
                      tab_stat_cpct(label=var_lab(q0016_0004),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0005))|>
                      tab_stat_cpct(label=var_lab(q0016_0005),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0006))|>
                      tab_stat_cpct(label=var_lab(q0016_0006),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0007))|>
                      tab_stat_cpct(label=var_lab(q0016_0007),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0008))|>
                      tab_stat_cpct(label=var_lab(q0016_0008),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0009))|>
                      tab_stat_cpct(label=var_lab(q0016_0009),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0016_0010))|>
                      tab_stat_cpct(label=var_lab(q0016_0010),total_row_position = "below")|>
                      tab_pivot(stat_position="inside_columns")|>
                      t())
```

```{r}
as.datatable_widget(AFE_data|>tab_cells("|" = unvr(q0017_0001))|>
                      tab_stat_cpct(label=var_lab(q0017_0001),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0002))|>
                      tab_stat_cpct(label=var_lab(q0017_0002),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0003))|>
                      tab_stat_cpct(label=var_lab(q0017_0003),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0004))|>
                      tab_stat_cpct(label=var_lab(q0017_0004),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0005))|>
                      tab_stat_cpct(label=var_lab(q0017_0005),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0006))|>
                      tab_stat_cpct(label=var_lab(q0017_0006),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0007))|>
                      tab_stat_cpct(label=var_lab(q0017_0007),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0008))|>
                      tab_stat_cpct(label=var_lab(q0017_0008),total_row_position = "below")|>
                      #tab_cells("|" = unvr(q0017_0009))|>
                      #tab_stat_cpct(label=var_lab(q0017_0009),total_row_position = "below")|>
                      tab_cells("|" = unvr(q0017_0010))|>
                      tab_stat_cpct(label=var_lab(q0017_0010),total_row_position = "below")|>
                      tab_pivot(stat_position="inside_columns")|>
                      t())
```

### Pruebas

Aquí tenemos una excelente matriz e indicador. Solo un indicador es aceptable.

```{r}
matrix_cor<-polychoric(AFE_data)
rho<-matrix_cor$rho
cor.plot(rho, xlas = 2, cex.axis = 0.8)
```

```{r}
#KMO
KMO(rho)
```

```{r}
n<-nrow(AFE_data)
cortest.bartlett(rho, n)
```

### Número de factores

Realizamos 4 pruebas. De todas varias nos apunta a dos resultados: 3 o 4 factores.

#### autovalores

```{r}
ei<-eigen(rho)$values
plot(ei,type="b",pch=20,col="blue")
num_factores_kaiser <- sum(ei > 1)  # Contar cuántos autovalores son mayores a 1
print(num_factores_kaiser)  # Mostrar número de factores sugeridos
```

#### Scree plot

```{r}
plot(ei, type="b", main="Scree Plot (Codo de Cattell)", xlab="Número de Factor", ylab="Autovalor")
abline(h=1, col="red", lty=2)  # Línea de referencia en autovalor = 1
```



#### Parallel analysis

```{r}
fa.parallel(rho, main = "Parallel", fa ="fa", fm="minres")
```

#### Eganet

```{r}
EGAnet::EGA(AFE_data, corr = "auto", plot.EGA = TRUE)
```

### 3 factores

```{r}
factorial <- fa(rho,nfactors = 3, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:3]
```

```{r,  fig.width=11}
fa.diagram(load)
```


### 4 factores

```{r}
factorial <- fa(rho,nfactors = 4, rotate = "varimax", fm = "minres")
print(factorial)
```

#### extracción y plot de factores

```{r}
print(factorial$loadings)
```

```{r}
print(factorial$loadings,cutoff = 0.3)
```

```{r}
load <- factorial$loadings[,1:4]
```

```{r,  fig.width=11}
fa.diagram(load)
```
